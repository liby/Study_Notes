# 4.2 执行环境及作用域

- 执行环境是JS中最为重要的一个概念，定义了变量或函数有权访问的其他数据，决定了它们各自的行为。
  - 每个执行环境都有一个与之关联的**变量对象**,环境中定义的所有变量和函数都保存在这个对象中。
  - 我们编写的代码无法访问这个对象，但解析器在处理数据时会在后台使用它。
- 全局执行环境是最外围的一个执行环境。
  - 根据JS实现所在的宿主环境不同，表示执行环境的对象也不一样。
  - 在Web浏览器中，全局执行环境被认为是window对象。

- 某个执行环境中的所有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁。
  - 全局执行环境直到应用程序退出时才会被销毁。
- 每个函数都有自己的**执行环境**。
  - 当执行流进入一个函数时，函数的环境就会被推入一个环境栈中。
    - 在函数执行之后，栈将其环境出，把控制权返回给之前的执行环境。

- 代码在一个环境中执行时，会创建变量对象的一个**作用域链**。
  - 作用域链会保证对执行环境有权访问的所有变量和函数的有序访问。
  - 作用域链的前端，始终都是当前执行的代码所在环境的变量对象。
    - 如果这个环境是函数，则将其**活动对象**作为变量对象。
      - 活动对象在最开始时只包含一个变量，即arguments对象(这个对象在全局环境中是不存在的)。
  - 作用域链中的下一个变量对象来自包含（外部）环境，而再下一个变量则来自下一个包含环境。这样一直延续到全局执行环境。
    - 全局执行环境的变量对象始终都是作用域链中的最后一个对象。
- 标识符解析是沿着作用域链一级一级地搜索标识符的过程，搜索过程始终从作用域链的前端开始，然后逐级地向后回溯，直至找到标识符为止。
  - 如果找不到标识符，通常会导致错误发生。

- 在局部作用域中定义的变量可以在局部环境中与全局变量互换使用。

- 内部环境可以通过作用域链访问所有的外部环境，但外部环境不能访问内部环境中的任何变量和函数。
  - 这些环境之间的联系是线性、有次序的。
  - 每个环境都可以向上搜索作用域链，以查询变量和函数名；
  - 任何环境都不能通过向下搜索作用域链而进入另一个执行环境。

> 函数参数也被当做变量来对待，因此其访问规则与执行环境中的其他变量相同。

## 4.2.1 延长作用域链

- 执行环境的类型总共只有两种——全局和局部(函数)。

- 有些语句可以在作用域链的前端临时增加一个变量对象，这个变量对象会在代码执行后被移除。
  - try-catch语句的catch块和with语句都会在作用域链的前端添加一个变量对象。
    - with语句会将指定的对象添加到作用域链中。
    - catch语句会创建一个新的变量对象，其中包含被抛出的错误对象的声明。

## 4.2.2 没有块级作用域

- JS没有块级作用域经常会导致理解上的困惑。

- 在JS中，if语句中的变量声明会将变量添加到当前的执行环境。

- JS中由for语句创建的变量i即使在for循环执行结束后，也依旧会存在于循环外部的执行环境中。

### 1.声明变量

- 使用var声明的变量会自动被添加到最接近的环境中，在函数内部，最接近的环境就是函数的局部环境。
  - 如果初始化变量时没有使用var声明，这个变量就会被添加到全局环境。

> 不声明而直接初始化变量是一个常见的错误做法，这样可能会导致意外。在严格模式下，初始化未经声明的变量会导致错误。

### 2.查询标识符

- 某个环境中为了读取或写入而引用一个标识符时，必须通过搜索来确定标识符的实际代表意义。
  - 从作用域链的前端开始，向上逐级查询与给定名字匹配的标识符。
    - 如果在全局环境中也没有找到，就说明这个变量没有声明。
  - 如果局部环境中存在着同名标识符，就不会使用位于父环境中的标识符。

> 访问局部变量要比访问全局变量更快，因为不用不用向上搜索作用域链。
