# this关键字

## 1.涵义

- tihs可以用在构造函数中，表示实例对象。
  - 不管用在什么场合，this总会返回一个对象。

- this就是属性或方法“当前”所在的对象。
  - `this.property`就代表property属性当前所在的对象。

- 由于对象的属性可以赋给另一个对象，所以属性所在的当前对象是可变的，即this的指向是可变的。
  - 函数内部使用了this关键字，随着函数所在的对象不同，this的指向也不同。

  ```js
  function f() {
    return "姓名： " + this.name;
  }
  var A = {
    name: "张三",
    describe: function () {
      return "姓名： " + this.name;
    }
  }

  var name = "李四";
  var f = A.describe;
  f() //"姓名： 李四"
  ```

- JS语言中，一切皆对象，运行环境也是对象，所有函数都是在某个对象之中运行，this就是函数运行时所在的对象(环境)
  - 但是JS支持运行环境动态切换，this的指向是动态的，没有办法事先确定到底是指向哪个对象。

## 2.实质

- JS语言之所以有this的设计，和内存里面的数据结构有关系。

- 如果将一个对象赋值给变量，JS引擎会先在内存里面生成一个对象，然后把这个对象的内存地址赋值给变量。
  - 变量是一个地址，如果要读取对象的属性，引擎要先从变量拿到内存地址，再从这个地址读出原始的对象，返回这个属性。
  - 如果属性的值是函数的话，引擎会将函数单独保存在内存中，然后再将函数的地址赋值给对象的属性。
    - 由于函数是一个单独的值，所以它可以在不同的环境（上下文)执行。
    ```js
    var f = function() {}
    var obj = { f: f}

    f()

    obj.f()
    ```

- JS允许在函数体内部，引用当前环境的其他变量。
- 由于函数可以在不同的运行环境执行，所以需要有一种机制能够在函数体内部获得当前的运行环境。
  - this的设计目的就是在函数体内部，指代函数当前的运行环境。

## 3.使用场合

- this主要有以下几个使用场合:
  1. 全局环境
      - 全局环境使用this，它指向顶层对象window
      - 不管是不是在函数内部，只要实在全局环境下运行，this就是指向顶层对象window
  2. 构造函数
      - 构造函数中的this指向实例对象
  3. 对象的方法
      - 如果对象的方法里包含this，this的指向就是方法运行时所在的对象，该方法赋值给另一个对象，就会改变this的指向。
        ```js
        var obj = {
          foo: function () {
            console.log(this);
          }
        }

        obj.foo() //obj

        //下面几种用法都会改变this的指向

        //情况一
        (obj.foo = obj.foo)() //window

        (obj.foo = function() {
          console.log(this);
        })()

        (function () {
          console.log(this);
        })()

        //情况二
        (false || obj.foo)() //window

        (false || function() {
          console.log(this);
        })()

        //情况三
        (1, obj.foo)() //window

        (1, function () {
          console.log(this);
        })()

        //上面三种情况，obj.foo被当作一个值来调用，运行环境已经不是obj，而是全局环境，this不再指向obj
        //JS引擎内部，obj和obj.foo储存在两个内存地址，称为地址1和地址2，obj.foo()这样调用是从地址1调用地址2，地址2的运行环境是地址1
        //上面三种情况都是直接取出地址2进行调用，这样的话，运行环境就是全局环境，因此this指向全局环境
        ```
- 如果this所在的方法不在对象的第一层，这时this只是指向当前一层的对象，不会继承更上面的层
  - 如果将其赋值给一个变量，this依然会指向全局对象，为了避免这种问题发生，可以只将this所在的对象赋值给变量